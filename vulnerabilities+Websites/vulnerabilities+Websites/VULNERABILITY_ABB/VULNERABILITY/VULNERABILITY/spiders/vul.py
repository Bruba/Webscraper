# -*- coding: utf-8 -*-
import scrapy
# import csv
import time
# import sys
# reload(sys)
# sys.setdefaultencoding('utf8')

from VULNERABILITY import settings
from VULNERABILITY.items import VulnerabilityItem
from selenium import webdriver
# from scrapy import signals
# from scrapy.xlib.pydispatch import dispatcher

class VulSpider(scrapy.Spider):
	name = "vul"
	start_urls = [
		"https://www.vulnerabilitycenter.com/svc/SVC.html#search=ABB"
	]

	# CSV_TITLE = [
			# "Skybox Id", "CVE Id", "Vendor", "Severity", "Reporting Date", "Last Modified", "Description"
			# ]

	def __init__(self, *args, **kwargs):
		self.driver = webdriver.PhantomJS()
		super(VulSpider, self).__init__(*args, **kwargs)
		# dispatcher.connect(self.spider_closed, signals.spider_closed)
		# self.csv_file = open("Results.csv", "wb")
		# self.csv_wr = csv.writer(self.csv_file, quoting=csv.QUOTE_ALL)
		# self.csv_wr.writerow(self.CSV_TITLE)
		
	# def spider_closed(self, spider):
		# self.csv_file.close()
		
	def parse(self, response):
		self.driver.get(response.url)
		time.sleep(6)
		search = self.driver.find_element_by_xpath('//table[@class="svc-NavigationButtonsContainer"]//tr/td[last()]/div')
		search = search.click()
		time.sleep(3)
		text = self.driver.find_element_by_xpath('//tr/td/input[@class="svc-SearchBox"]')
		text.clear()
		text.send_keys('ABB')
		self.driver.find_element_by_xpath('//tr/td/button[@class="svc-Button"]').click()
		time.sleep(5)
		
		items = VulnerabilityItem()
		
		
		for sel in self.driver.find_elements_by_xpath('//tr[starts-with(@class, "GMMNKTXCAEC GMMNKTXCHYC GMMNKTXCAL ")]'):
			Skybox = sel.find_element_by_xpath('./td[1]/div/div/a').get_attribute('textContent')
			items['Skybox'] = Skybox
			CVE = sel.find_element_by_xpath('./td[2]/div/div').get_attribute('textContent')
			items['CVE'] = CVE
			Vendor = sel.find_element_by_xpath('./td[3]/div/div/a').get_attribute('textContent')
			items['Vendor'] = Vendor
			Severity = sel.find_element_by_xpath('./td[4]/div/div').get_attribute('textContent')
			items['Severity'] = Severity
			Reporting = sel.find_element_by_xpath('./td[5]/div/div').get_attribute('textContent')
			items['Reporting'] = Reporting
			Modified = sel.find_element_by_xpath('./td[6]/div/div').get_attribute('textContent')
			items['Modified'] = Modified
			Description = sel.find_element_by_xpath('./td[7]/div/div').get_attribute('textContent')
			items['Description'] = Description
			
			yield items

			
			# data = [
				# Skybox,
				# CVE,
				# Vendor,
				# Severity,
				# Reporting,
				# Modified,
				# Description
			# ]
			# self.csv_wr.writerow(data)